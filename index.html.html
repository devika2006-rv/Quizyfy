<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye-Tracking MCQ System</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            gap: 30px;
            width: 100%;
        }
        
        .camera-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .video-container {
            position: relative;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        video {
            width: 100%;
            border-radius: 10px;
            transform: scaleX(-1);
            background: #000;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .status {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 20px;
            margin: 10px 0;
            text-align: center;
            width: 100%;
        }
        
        .instructions {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .quiz-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .question-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .question-text {
            font-size: 1.3rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        
        .option.highlighted {
            background: rgba(255, 215, 0, 0.3);
            transform: scale(1.02);
        }
        
        .option.selected {
            background: rgba(50, 205, 50, 0.3);
        }
        
        .option-label {
            font-weight: bold;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
        }
        
        .progress-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-bar {
            height: 100%;
            background: gold;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .results {
            text-align: center;
            font-size: 1.2rem;
            margin-top: 10px;
            min-height: 30px;
        }
        
        .gaze-pointer {
            position: fixed;
            width: 30px;
            height: 30px;
            border: 3px solid red;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.2);
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            transition: transform 0.1s ease;
        }
        
        .gaze-pointer::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background: red;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Eye-Tracking MCQ System</h1>
            <p class="subtitle">Answer questions by looking at your desired option for 2 seconds</p>
        </header>
        
        <div class="main-content">
            <div class="camera-section">
                <h2>Eye Tracking</h2>
                <div class="video-container">
                    <video id="video" autoplay></video>
                    <canvas id="output-canvas"></canvas>
                </div>
                <div class="status">
                    <p id="status">Initializing camera...</p>
                </div>
                <div class="instructions">
                    <p>➊ Position yourself about 50cm from the camera</p>
                    <p>➋ Ensure good lighting on your face</p>
                    <p>➌ Look at your desired option for 2 seconds to select it</p>
                    <p>➍ The red pointer shows where we detect your gaze</p>
                </div>
            </div>
            
            <div class="quiz-section">
                <div class="question-card">
                    <h2>Question <span id="question-number">1</span> of 5</h2>
                    <p class="question-text" id="question">Which of these is not a programming language?</p>
                    
                    <div class="options">
                        <div class="option" id="option-1">
                            <div class="option-label">A</div>
                            <div class="option-text">Python</div>
                            <div class="progress-container">
                                <div class="progress-bar" id="progress-1"></div>
                            </div>
                        </div>
                        <div class="option" id="option-2">
                            <div class="option-label">B</div>
                            <div class="option-text">Java</div>
                            <div class="progress-container">
                                <div class="progress-bar" id="progress-2"></div>
                            </div>
                        </div>
                        <div class="option" id="option-3">
                            <div class="option-label">C</div>
                            <div class="option-text">HTML</div>
                            <div class="progress-container">
                                <div class="progress-bar" id="progress-3"></div>
                            </div>
                        </div>
                        <div class="option" id="option-4">
                            <div class="option-label">D</div>
                            <div class="option-text">C++</div>
                            <div class="progress-container">
                                <div class="progress-bar" id="progress-4"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="results" id="result"></div>
                    
                    <div class="controls">
                        <button id="prev-btn">Previous</button>
                        <button id="next-btn">Next</button>
                        <button id="reset-btn">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="gaze-pointer" id="gaze-pointer"></div>

    <script>
        // Questions for the quiz
        const questions = [
            {
                question: "Which of these is not a programming language?",
                options: ["Python", "Java", "HTML", "C++"],
                correct: 2
            },
            {
                question: "What does CSS stand for?",
                options: ["Computer Style Sheets", "Creative Style System", "Cascading Style Sheets", "Colorful Style Sheets"],
                correct: 2
            },
            {
                question: "Which technology is used for eye tracking in this project?",
                options: ["TensorFlow.js", "OpenCV", "MediaPipe", "PyTorch"],
                correct: 2
            },
            {
                question: "Which of these is a JavaScript framework?",
                options: ["Django", "Laravel", "React", "Flask"],
                correct: 2
            },
            {
                question: "What is the default dwell time for selection in this system?",
                options: ["1 second", "2 seconds", "3 seconds", "5 seconds"],
                correct: 1
            }
        ];

        // Global variables
        let currentQuestion = 0;
        let selectedOption = -1;
        let gazeTimer = null;
        let gazeStartTime = 0;
        let lookingAtOption = -1;
        
        // DOM Elements
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('output-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusElement = document.getElementById('status');
        const gazePointer = document.getElementById('gaze-pointer');
        
        // Initialize questions
        function initializeQuestion() {
            const question = questions[currentQuestion];
            document.getElementById('question-number').textContent = currentQuestion + 1;
            document.getElementById('question').textContent = question.question;
            
            for (let i = 0; i < 4; i++) {
                document.getElementById(`option-${i+1}`).classList.remove('selected', 'highlighted');
                document.getElementById(`option-${i+1}`).querySelector('.option-text').textContent = question.options[i];
                document.getElementById(`progress-${i+1}`).style.width = '0%';
            }
            
            document.getElementById('result').textContent = '';
        }
        
        // Initialize the application
        function init() {
            // Set canvas size
            canvasElement.width = videoElement.offsetWidth;
            canvasElement.height = videoElement.offsetHeight;
            
            initializeQuestion();
            setupEventListeners();
            initializeCamera();
        }
        
        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('next-btn').addEventListener('click', nextQuestion);
            document.getElementById('prev-btn').addEventListener('click', prevQuestion);
            document.getElementById('reset-btn').addEventListener('click', resetQuestion);
        }
        
        // Move to next question
        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                selectedOption = -1;
                initializeQuestion();
            }
        }
        
        // Move to previous question
        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                selectedOption = -1;
                initializeQuestion();
            }
        }
        
        // Reset current question
        function resetQuestion() {
            selectedOption = -1;
            initializeQuestion();
        }
        
        // Update gaze pointer position
        function updateGazePointer(x, y) {
            gazePointer.style.left = `${x}px`;
            gazePointer.style.top = `${y}px`;
        }
        
        // Check if gaze is on an option
        function checkGazeOnOption(gazeX, gazeY) {
            const options = document.querySelectorAll('.option');
            let currentOption = -1;
            
            options.forEach((option, index) => {
                const rect = option.getBoundingClientRect();
                
                // Check if gaze is within the option bounds
                if (gazeX >= rect.left && gazeX <= rect.right && 
                    gazeY >= rect.top && gazeY <= rect.bottom) {
                    currentOption = index;
                    
                    // Highlight the option
                    option.classList.add('highlighted');
                    
                    // Start timer if not already started
                    if (lookingAtOption !== index) {
                        lookingAtOption = index;
                        gazeStartTime = Date.now();
                        
                        // Clear any existing timer
                        if (gazeTimer) {
                            clearInterval(gazeTimer);
                        }
                        
                        // Set up timer to update progress bar
                        gazeTimer = setInterval(() => {
                            const elapsed = Date.now() - gazeStartTime;
                            const progress = Math.min((elapsed / 2000) * 100, 100);
                            
                            document.getElementById(`progress-${index+1}`).style.width = `${progress}%`;
                            
                            // If dwell time completed, select the option
                            if (elapsed >= 2000) {
                                selectOption(index);
                                clearInterval(gazeTimer);
                                gazeTimer = null;
                            }
                        }, 50);
                    }
                } else {
                    // Remove highlight
                    option.classList.remove('highlighted');
                    
                    // Reset progress if moved away from this option
                    if (lookingAtOption === index) {
                        document.getElementById(`progress-${index+1}`).style.width = '0%';
                        clearInterval(gazeTimer);
                        gazeTimer = null;
                        lookingAtOption = -1;
                    }
                }
            });
            
            // If not looking at any option
            if (currentOption === -1 && gazeTimer) {
                clearInterval(gazeTimer);
                gazeTimer = null;
                lookingAtOption = -1;
            }
        }
        
        // Select an option
        function selectOption(optionIndex) {
            selectedOption = optionIndex;
            
            // Update UI
            const options = document.querySelectorAll('.option');
            options.forEach((option, index) => {
                if (index === optionIndex) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
                option.classList.remove('highlighted');
                document.getElementById(`progress-${index+1}`).style.width = '0%';
            });
            
            // Check if answer is correct
            const isCorrect = optionIndex === questions[currentQuestion].correct;
            document.getElementById('result').textContent = isCorrect ? 
                "Correct! ✅" : "Incorrect! ❌";
            
            // Move to next question after a delay if correct
            if (isCorrect && currentQuestion < questions.length - 1) {
                setTimeout(() => {
                    nextQuestion();
                }, 1500);
            }
        }
        
        // Initialize camera and face mesh
        function initializeCamera() {
            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await faceMesh.send({image: videoElement});
                },
                width: 640,
                height: 480
            });
            
            camera.start();
            
            // Initialize MediaPipe FaceMesh
            const faceMesh = new FaceMesh({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                }
            });
            
            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            faceMesh.onResults(onFaceMeshResults);
            
            statusElement.textContent = "Camera active. Looking for face...";
        }
        
        // Process FaceMesh results
        function onFaceMeshResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiFaceLandmarks) {
                for (const landmarks of results.multiFaceLandmarks) {
                    drawLandmarks(landmarks);
                    
                    // Calculate gaze direction (simplified)
                    const gazeX = calculateGazeX(landmarks);
                    const gazeY = calculateGazeY(landmarks);
                    
                    // Map gaze to screen coordinates
                    const screenX = window.innerWidth * gazeX;
                    const screenY = window.innerHeight * gazeY;
                    
                    // Update gaze pointer position
                    updateGazePointer(screenX, screenY);
                    
                    // Check if gaze is on any option
                    checkGazeOnOption(screenX, screenY);
                }
                
                statusElement.textContent = "Face detected. Tracking gaze...";
            } else {
                statusElement.textContent = "No face detected. Adjust your position.";
            }
            
            canvasCtx.restore();
        }
        
        // Draw face landmarks (for visualization)
        function drawLandmarks(landmarks) {
            // Draw iris landmarks (simplified)
            const leftEyeIndices = [468, 469, 470, 471, 472];
            const rightEyeIndices = [473, 474, 475, 476, 477];
            
            drawEyeLandmarks(leftEyeIndices, landmarks, '#00FF00');
            drawEyeLandmarks(rightEyeIndices, landmarks, '#00FF00');
            
            // Draw a simplified representation of the face
            drawSimplifiedFace(landmarks);
        }
        
        // Draw eye landmarks
        function drawEyeLandmarks(indices, landmarks, color) {
            canvasCtx.strokeStyle = color;
            canvasCtx.lineWidth = 1;
            
            canvasCtx.beginPath();
            
            for (let i = 0; i < indices.length; i++) {
                const landmark = landmarks[indices[i]];
                const x = landmark.x * canvasElement.width;
                const y = landmark.y * canvasElement.height;
                
                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
                
                // Draw points
                canvasCtx.beginPath();
                canvasCtx.arc(x, y, 2, 0, 2 * Math.PI);
                canvasCtx.fillStyle = color;
                canvasCtx.fill();
            }
            
            canvasCtx.closePath();
            canvasCtx.stroke();
        }
        
        // Draw a simplified representation of the face
        function drawSimplifiedFace(landmarks) {
            // Draw face outline
            canvasCtx.strokeStyle = '#FF00FF';
            canvasCtx.lineWidth = 1;
            
            const faceOutlineIndices = [10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288, 397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136, 172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109];
            
            canvasCtx.beginPath();
            for (let i = 0; i < faceOutlineIndices.length; i++) {
                const landmark = landmarks[faceOutlineIndices[i]];
                const x = landmark.x * canvasElement.width;
                const y = landmark.y * canvasElement.height;
                
                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
            }
            canvasCtx.closePath();
            canvasCtx.stroke();
        }
        
        // Calculate simplified horizontal gaze direction
        function calculateGazeX(landmarks) {
            // Use relative position of iris landmarks to estimate gaze
            const leftEyeInner = landmarks[133];
            const leftEyeOuter = landmarks[33];
            const rightEyeInner = landmarks[362];
            const rightEyeOuter = landmarks[263];
            
            const leftEyeWidth = Math.abs(leftEyeOuter.x - leftEyeInner.x);
            const rightEyeWidth = Math.abs(rightEyeOuter.x - rightEyeInner.x);
            
            const leftIris = landmarks[468];
            const rightIris = landmarks[473];
            
            const leftGazeRatio = (leftIris.x - leftEyeInner.x) / leftEyeWidth;
            const rightGazeRatio = (rightIris.x - rightEyeInner.x) / rightEyeWidth;
            
            // Average both eyes
            const avgGaze = (leftGazeRatio + rightGazeRatio) / 2;
            
            // Map to screen coordinates (simplified)
            return Math.min(1, Math.max(0, avgGaze));
        }
        
        // Calculate simplified vertical gaze direction
        function calculateGazeY(landmarks) {
            // Use relative position of iris landmarks to estimate gaze
            const leftEyeTop = landmarks[159];
            const leftEyeBottom = landmarks[145];
            const rightEyeTop = landmarks[386];
            const rightEyeBottom = landmarks[374];
            
            const leftEyeHeight = Math.abs(leftEyeBottom.y - leftEyeTop.y);
            const rightEyeHeight = Math.abs(rightEyeBottom.y - rightEyeTop.y);
            
            const leftIris = landmarks[468];
            const rightIris = landmarks[473];
            
            const leftGazeRatio = (leftIris.y - leftEyeTop.y) / leftEyeHeight;
            const rightGazeRatio = (rightIris.y - rightEyeTop.y) / rightEyeHeight;
            
            // Average both eyes
            const avgGaze = (leftGazeRatio + rightGazeRatio) / 2;
            
            // Map to screen coordinates (simplified)
            return Math.min(1, Math.max(0, avgGaze));
        }
        
        // Start the application when the page loads
        window.onload = init;
    </script>
</body>
</html>